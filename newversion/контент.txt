===
Системный компонент "Контент"
===

Этот компонент пришел на замену старому модулю материалов (articles). Основная причина связана с тем, что поменялось ядро и принцип работы с базой данных через драйвер. Также было сделано множество оптимизаций, которые потребовали нового подхода. Часть настроек была сгруппирована и перенесена в новое место, часть переименовалась, т.к. переименовался сам компонент, терминология и принципы работы. Помимо этого, компонент теперь будет объединять несколько функций: вывод материалов из базы данных, вывод материалов из таблицы, импорт материалов из таблицы в базу данных, слияние данных из базы данных и таблицы, а также извлечение данных с других ресурсов.

Компонент ни в чем не уступает предыдущему модулю, однако он получил более жесткие требования, которые, тем не менее, направлены на облегчение его кастомизации через настройки и упрещения в работе при выводе в шаблонах.

Этот компонент еще будет дорабатываться, т.к. поначалу будет реализован не весь функционал.

===
Описание
===

Теперь контент - это не модуль вывода, а системный компонент. Но принцип его работы сделан по тому же принципу, что и модуль.

Материалами мы называем содержимое, т.е. все статьи, новости и пр.

Материалы сгруппированы по родителям. В локальной базе данных это представлено в виде файлов внутри папок. Поэтому один материал может относится к одному родителю. Хотя в иной базе данных теоретически можно отнести материал к нескольким родителям одновременно. Логических ограничений нет, хотя данная возможность не тестировалась.

Каждого родителя с принадлежащими ему материалами мы будем называть группой или группой материалов.

Материалы хранятся в базе данных в разделе 'content' с полем родителя по названию группы.

Настройки группы хранятся там же, в записях с названием группы и типом 'settings'.

Шаблоны для вывода материалов хранятся в папке 'custom/content/имя_группы'.

===
Формат данных
===

Из базы данных мы получаем стандартные поля:

id | name | type | parent | ctime | mtime | self | data

id - номер материала или его идентификатор
name - название материала на латинице, также используемое в ссылке
type - тип, пока не используется
parent - родительская категория материала
ctime - время создания материала
mtime - время последнего изменения материала
self - список пользователей, которые считаются авторами материала
* используется исключительно для ограничения правил доступа к базе данных,
однако может использоваться и при выводе материала, например в качестве указания автора статьи,
но для этого нужно будет обращаться к базе данных пользователей и извлекать оттуда разрешенную информацию об авторе,
что из-за отсутствия проработки безопасности вывода личных данных пока не реализовано
data - массив данных материала

Помимо этих полей существуют стандартные назначения, которые могут применяться к любому заданному полю из массива данных:

type - тип поля, для разных типов существуют разные настройки:
	text - поле в виде текста
	image - поле в виде ссылки на изображение
	date - поле в виде даты
	number - поле в виде числа
	allow - поле в виде одного или нескольких допустимых значений
	boolean - поле в виде логического значения true/false
	
По-умолчанию или если не задан, считается, что поле в виде текста.
	
настройки для текста:
	len - длина текста
	units - единицы измерения длины текста
	default - стандартное значение поля, если оно пустое
	* также можно указать массив, и тогда значение будет выбираться случайным образом
	mask - маска значения из других полей
	* например: "{db:name}_{data:field}"
	где 'db' означает указание полей материала, взятых из базы данных,
	'data' указывает на значение полей, взятых из массива данных,
	а 'lang' - из языкового массива,
	впоследствии также возможно добавление других источников
	clear - правила очистки поля через функцию clear
	* если пусто или false, очистка применяться не будет, для запуска нужно поставить true
	array - разобрать значение текущего поля как массив значений через точку с запятой
	* если пусто или false, разбор как массив применяться не будет, для запуска нужно поставить true

настройки для изображения:
	path - базовый путь, который будет добавляться вперед к каждой ссылке
	* для всех ссылок корневой будет папка PATH_LOCAL/URL_LOCAL,
	поэтому желательно, чтобы путь заканчивался на слеш, но при этом без слеша вначале
	default - то же, что и в тексте, но применяется к формированию ссылки
	mask - то же, что и в тексте, но применяется к формированию ссылки и с теми же требованиями, что path
	* например: "images/{db:parent}/{db:name}_{data:field}/"
	array - то же, что и в тексте

настройки для даты:
	in - формат введенной даты, по-умолчанию или если не задан, считается формат временной метки UNIX
	out - формат вывода даты, по-умолчанию или если не задан, считается формат, указанных в языковых настройках
	default - так же, как в тексте
	mask - так же, как в тексте
	array - так же, как в тексте

настройки для числа:
	min - минимально допустимое число
	max - максимально допустимое число
	convert - параметры конверсии через функцию datanum
	multiply - параметры множителя через функцию datanum
	grammar - параметры грамматики для функции datanum с преобразованием через datanumgrammar
	default - так же, как в тексте, но будет преобразовано в число
	random - если поле пустое, то будет генерировать случайное значение от min до max включительно
	* если пусто или false, разбор как массив применяться не будет, для запуска нужно поставить true
	mask - так же, как в тексте, но будет преобразовано в число
	array - так же, как в тексте

настройки для разрешенных значений:
	list - массив допустимых значений
	* если задан без ключей, то значение поля проверяется на присутствие в массиве,
	если задан с ключами, то каждому ключу подставляется соответствующее значение
	default - стандартное значение или ключ, если поле пустое

настройки для логического значения:
	default - стандартное значение
	random - если поле пустое, будет генерировать случайное значение
	* если пусто или false, разбор как массив применяться не будет, для запуска нужно поставить true
	mask - маска применяется так же, как в тексте, но любое значение маски, в том числе 0, будет распознаваться как true

Все эти настройки касаются предварительной обработки данных перед выводом в шаблоне. Т.е. они вовсе не обязательны, но помогают автоматизировать процесс.

===
Настройки
===

parents - задает родителей, можно указывать несколько через двоеточие, таким образом, можно создать группу без материалов, которая будет включать материалы других групп

	"parents" : "one:two"

table - задает в качестве родителя таблицу

	"table" : "one:two"

	таблица может быть одна, может быть несколько
	таблицы должны быть в формате csv и лежать в папке PATH_CUSTOM . 'content'
	таблицы обрабатываются таким образом:
	загружается файл таблицы, первая строка интерпретируется как название ключей
	далее составляется массив,
	в данные интерпретируются поля, имеющие ключ data:field_name
	далее массив по полю 'name' сливается с уже полученным массивом материалов,
	правило по-умолчанию такое: если материалы пустые, то все материалы создаются из таблицы, иначе заменяются или добавляются данными из таблицы только существующие материалы

names - строка с указанием конкретных материалов, через двоеточие, которые нужно включить

	"names" : ""

exclude - строка с указанием конкретных материалов, через двоеточие, которые нужно исключить

	"exclude" : ""

filter - строка фильтрации согласно драйверу бд, задает условия, которые будут применяться при загрузке материалов еще до параметров, указанных в адресной строке

	"filter" : ""

sort - строка сортировки согласно драйверу бд

	"sort" : ""

count (раньше articles, lastnews)
	число выводимых новостей
	когда не указан параметр /all/, выводится только это число новостей
	если указан параметр skip, то счет идет с первой новости после пропущенных
	(например, новости 0,1,2 пропущены, выводим 5 - это будут новости 3,4,5,6 и 7)
	0 - все

skip (раньше firstnews)
	число новостей с начала, которые нужно пропустить,
	или по-другому - номер первой выводимой новости
	иногда может возникнуть ситуация, когда несколько новостей нужно пропустить,
	например, когда три новости идут в топ и показываются в отдельном модуле,
	а затем идут остальные новости и показываются в отдельном модуле
	0 - нет

len
	длина описания материала, только для /all/ и /skip/
	число, по-умолчанию - все

lentype
	измерение длины новости в превью
	по-умолчанию - в символах,
	words - в словах,
	phrase - во фразах (предложениях)
	paragraph - в абзацах (до первого <br>, </p> или переноса строк \n)
	break - до специального разрыва <hr class="break">

fields - задает новые поля, описание было выше

defaults - задает поля, значения которых будут взяты для общих целей

	"defaults" : {
		"title" : "field_name", // заголовок для СЕО
		"description" : "field_name", // описание для СЕО
		"image" : "field_name", // изображение для материала
		"top" : "field_name", // выделение топовых материалов
		"enable" : "field_name", // разрешение на публикацию, т.е. вывод материала - если это поле пустое или false, то материал будет пропущен
		"ftime" : "field_name" // время окончания публикации материала (если меньше, чем текущее время, то не выводится)
	}

points - задает поля и условия для оценок, голосования и учета статистики

	"points" : {
		"enable" : true/false, // включить/выключить систему оценок
		"min" : num, // минимальная оценка
		"max" : num, // максимальная оценка
		"total" : "field_name", // поле с общей оценкой
		"average" : "field_name", // поле со средней оценкой
		"count" : "field_name", // поле с числом голосов
		"views" : "field_name", // число просмотров, отображений материала
		"target" : "field_name" // счетчик числа достижений цели
	}

dates - задает условия для вывода материалов, соответствующих определенным датам, если указана строка, то дата берется согласно формату, и переводятся в формат UNIX, но если указано число, то оно переводится не будет

	"dates" : {
		"enable" : true/false, // включить/выключить вывод по датам, exclude - исключить эти даты
		"type" : "", // тип даты - create = ctime, modify = mtime
		"start" : "", // начальная дата, если не указана, то считается от −2 147 483 648 в формате UNIX
		"final" : "", // конечная дата, если не указана, то считается текущая
		"format" : "", // формат даты, если не указан, то считается в формате UNIX 
	}

pagination - разделение материалов на страницы, число материалов на странице берется из раздела page -> count, число страниц высчитывается автоматически, учитывая сортировку и пропуски

	"pagination" : true/false // включить/выключить

elements - дополнительные элементы на странице, в частности, кнопки; значения для всех: after, before и both/true

	"elements" : {
		"all" : "", // открыть список всех материалов
		"back" : "", // вернуться назад (из одного материала к списку)
		//"pagination" : "", // вывести кнопки страниц
		"navigation" : "" // вывести кнопки навигации по страницам
		
	("pagination")
		"pages" : "", // кнопки страниц
		"navigation" : "", // кнопки навигации вперед/назад
		"extremepoints" : "", // кнопки перемещения в начало/в конец
		"extremepages" : "", // кнопки первой и последней страниц
		"displaypages" : "" // отображаемое число страниц (всегда нечетное, если четное, то увеличивается на 1)
		
	}



===
Оценки
===

Система оценок ведется через массив $points:

	$points = null;
	if (!empty($settings['points'])) { $points = !empty($settings['points']); }

Система оценок включается, если массив $points не пустой и включено значение в ключе 'enable' массива:

	if (empty($points) || empty($points['enable'])) { return false; }

Учет ведется по полям, заданным через:

	$points['total']
	$points['average']
	$points['count']

Допустимая оценка рассчитывается в процессе от:

	$points['min']
	$points['max']

Таким образом, можно сделать балльную систему, например от 1 до 5, либо лайк/дизлайк - от -1 до 1. Ноль баллов никогда не учитывается и не отображается.

Каждый раз при голосовании запускается процесс, который пересчитывает баллы:

	$points['total'] = $points['total'] + hit;
	$points['count']++;
	$points['average'] = $points['total'] / $points['count'];

Дополнительно к механизму оценок запускается учет показов через поле, заданное в:

	$points['views']

Таким образом, при каждом запросе материала, даже если не была выставлена оценка, будет запускаться процесс, который увеличивает счетчик показов на 1:

	$points['views']++;

По аналогии с показами есть поле достижения цели, заданное в:

	$points['target']

При каждом достижении цели будет запускаться процесс, который увеличивает этот счетчик показов на 1:

	$points['target']++;

Целью может быть все, что угодно - клик, прокрутка вниз, отображение какого-либо элемента. Главная особенность данного счетчика в том, что он учитывается через специальный процесс, который вызывается ajax-запросом через скрипт.

Грубо говоря, если показы учитываются автоматически при отображении материала, а оценки - при щелчке по голосованию, то счетчик цели активируется через скрипт.

Данный механизм оценок позволит вам использовать их достаточно гибко. С учетом любого из этих показателей вы можете фильтровать и сортировать материалы.

Обработка и учет будет производится системой, но вызов процесса, скорее всего, будет возложен на скрипт.

===
Приоритет обработки настроек
===



===
Кейсы
===

1. На сайте нет модуля материалов, т.к. это простой лендинг. Он должен грузится быстро.

> В общем-то реализовано: просто в структуре не указывается параметр 'content'.

2. На сайте обычный модуль материалов, т.е. материалы должны грузиться автоматом по структуре с автоподгрузкой СЕО.

> В старой версии вызывался элемент 'роутинг' базового шаблона и там автоматически запускался модуль материалов.
> В новой версии для одного материала автоматически запускается компонент материалов.

3. Это новостной сайт. Должны быть три новости в слайдере, отмеченные как в топе, и остальные внизу, включая новости, помеченные как в топе, но не входящие в те три.

4. Это новостной сайт. На одной странице должны выводится все новости за определеный промежуток времени.

5. Это сайт каталога. Есть товары и бутики. Материалы отображаются как обычно, но в шаблоне вывода, после материала, отображаются другие товары из этого бутика, плюс список бутиков.

> В старой версии в шаблоне вызывался новый модуль с новыми параметрами.
> В новой версии ...

6. Есть материал, который нужно снять с публикации через 3 дня.

> Обработка системой через ftime

7. Есть материал, который нужно перестать показывать, когда количество его просмотров станет больше 1000

> Вопрос в том, как учитывать хиты, т.е. просмотры. Также можно задать поле для оценки материала по лайкам/дизлайкам или по балльной системе (например, пяти- или десятибалльной).
> Однако здесь есть засада - каждая оценка, либо каждый просмотр должен вносить изменения в базу данных. Автоматически это, очевидно, не делается и может быть запрещено системой.
> Поэтому либо создавать общий пункт хитов для всех записей в базе данных - только зачем он нужен и как его считать? И делать системный процесс увеличения хитов. Но не будет ли это дырой?
> В любом случае придется делать системный процесс. А вот настраивать его можно по-разному. Например, мы можем предусмотреть три типа: клики, показы и оценки.

8. Есть материал, в котором нужно с 1 января нового года вместо одной цифры показывать другую

9. Нужно во всех материалах показывать две цены - исходную и с установленной скидкой, причем скидка берется разная для товаров из разных групп. Если скидки на товар нет, то считается скидка пользователя.

> Скидка от группы берется из настроек полей группы, где создается доп.поле со специальным значением. Скидка от пользователя берется системой из данных пользователя. Итоговая скидка рассчитывается системой и выводится в шаблон.
> Возможно, пользователь сумеет подделать запрос и даже оплатить меньшую сумму, однако система при проверке оплаты должна заново формировать сумму по тому же алгоритму и сверять, сколько должно было быть к оплате и сколько было оплачено по факту.






Если при вызове модуля указать второй параметр true, то он примет значение true в $module -> this
Это позволит загружать статью, которая определена по названию текущей страницы

Если при вызове модуля указать второй параметр со строковым значением, то он примет указанное значение в $module -> this
Это позволит загружать кастомную статью

Если при вызове модуля указать второй параметр со строковым значением 'all', то он примет это же значение в $module -> this
Это позволит сбросить определитель статей и загружать все статьи

Если при вызове модуля указать второй параметр со значением объекта или массива, то значение $module -> this примет значение 'all',
а содержимое объекта или массива будет интерпретировано как фильтр



Шаблон по-умолчанию грузит основные условия и элементы, а затем подгружает шаблоны разделов:

	для одного материала внутри другого раздела грузится шаблон name_inner.php
	для одного материала грузится шаблон name_alone.php
	для списка грузится шаблон name_all.php
	если данных шаблонов нет, то грузится шаблон name_default.php
	
	для кнопок грузится шаблон name_buttons.php
	
	если название страницы не совпадает с параметром модуля, то грузятся доп.страницы:
	в начале вывода материалов name_before.php
	после вывода материалов name_after.php
	зачем сделано это правило - хз, вроде бы оно нигде у меня не используется
	
	для всех этих шаблонов и страниц существует предварительная проверка
	и если какая-то из них отсутствует, то она либо пропускаются, либо вместо нее грузится страница по-умолчанию



Фильтр материалов работает следующим образом.

{
	
	"filter" : {
		"fields" : {
			"name" : "type",
			"name" : "type",
			"name" : "type"
		},
		"options" : {
			"ajax" : true,
			"label" : true,
			"wrapper" : true,
			"reset" : true,
			"pages" : true
		},		
		"items" : {
			"allow" : true,
			"min" : 1,
			"max" : 2,
			"multiply" : 10
		}
	}
	// включение фильтрации
	// значения: true/false/array
	// если задан массив, то указывается:
	//   fields - поля для фильтра и каждому один из типов:
	//     select - простой выбор (то же, если не задан), вызывает объект формы select/options
	//     multiple - множественный выбор по логическому "и", вызывает объект формы select/options с параметром multiple
	//     radio - простой выбор, вызывает объект формы radio
	//     and - множественный выбор по логическому "и", т.е. совпадение всех из выбранных, вызывает checkbox
	//     or - множественный выбор по логическому "или", т.е. совпадение любого из выбранных, вызывает checkbox
	//     num - диапазон значений
	//     range, range_jqueryui, range_bootstrap - выбор диапазона значений по двум ползункам (последние два требуют подключения соответствующих библиотек)
	//     search - поиск совпадения
	//     list - ввод вручную с подставлением значения из набора // пока нет
	//   options - настройки фильтрации
	//     ajax - разрешить фильтр через ajax
	//     label - разрешить теги label
	//     wrapper - разрешить обертку для группы выбора
	//     reset - разрешить кнопку очистки фильтра
	//     pages - разрешить пагинацию, т.е. выводить страницы
	//   items - вывод ограниченного числа материалов
	//     allow - разрешить/запретить
	//     min - число материалов по-умолчанию
	//     max - максимальное число материалов
	//     multiply - множитель
	
}

Во-первых, фильтр срабатывает только для страницы с параметром all (т.е. когда выведены все материалы). Например, страница должна иметь вид: http://site.ru/cathegory/all/filter/...

Далее фильтрация идет по параметрам материала, когда сначала указывается параметр, а затем его значение.

Например, для пусть материалы в категории cathegory имеют поля:
	type с возможными значениями shuba, kurtka и dublenka
	matherial с возможными значениями norka, koja и muton
	
Ссылка вида http://site.ru/cathegory/all/filter/type/shuba/matherial/norka выведет все материалы, в которых значение type будет shuba, а значение matherial - norka
Ссылка вида http://site.ru/cathegory/all/filter/type/shuba/matherial/koja не выведет ничего, т.к. скорее всего материалов с такими параметрами не существует

Также значения можно комбинировать, применяя дополнительные символы фильтрации:

Ссылка вида http://site.ru/cathegory/all/filter/type/shuba/matherial/norka+koja выведет все материалы, в которых значение matherial будет norka и koja
Ссылка вида http://site.ru/cathegory/all/filter/type/shuba/matherial/norka,koja выведет все материалы, в которых значение matherial будет norka или koja
Ссылка вида http://site.ru/cathegory/all/filter/type/shuba/matherial/*er выведет все материалы, в которых в значении matherial будет содержаться 'er'

Ссылки вида
	http://site.ru/cathegory/all/filter/type/shuba/matherial/-75
	http://site.ru/cathegory/all/filter/type/shuba/matherial/75-
	http://site.ru/cathegory/all/filter/type/shuba/matherial/0-75
выведут все материалы, в которых значение matherial будет находиться в диапазоне заданных чисел
Причем '-75' означает диапазон от минус бесконечности до 75, а '75-' - от 75 до бесконечности

Зарезервированный системой параметр фильтр - items, который позволяет вывести ограниченное число материалов

(!!!) Символы фильтрации далее возможно можно будет кастомизировать в параметрах filters, значения по-умолчанию:
	"symbols" : {
		"and" : "+",
		"or" : ",",
		"search" : "*",
		"num" : "-"
	}



Есть проблемы с интерпретацией и выводом материалов на старых сайтах, где раньше использовалась старая версия модуля вывода материалов.

Нужно все просмотреть и отладить.

Также нужно добавить в СЕО-алгоритм извлечение данных из материала, т.к. материал фактически уже задан через роутер.



Примеры использования.

Простой вызов:

module(['articles', '...group...']);

при этом будет вызываться шаблон с именем группы или, если такого нет, то шаблон по-умолчанию

Вывод ВСЕХ материалов группы:

module(['articles', '...group...', '...template...'], 'all');

Вывод одного определенного материала группы:

module(['articles', '...group...', '...template...'], '...name...');

Простой вывод с иными параметрами:

module(['articles', false, false, '{...}']);

Вывод заданного количества (2) случайных материалов:

module(['articles', '...group...', '...template...', '{"all":{"articles":2},"sort":{"type":"random"}}'], 'all');

Вывод всех материалов, кроме открытого:

module(['articles', '...group...', '...template...', '{"skip":"' . thispage('articlename') . '"}'], 'all');
